# 传输层

传输层提供了进程间的逻辑通信，传输层向高层用户屏蔽了下面网络层的核心细节，使应用程序看起来像是在两个传输层实体之间有一条端到端的逻辑通信信道。

## TCP

传输控制协议 TCP（Transmission Control Protocol）是**面向连接的、可靠的、基于字节流**的传输层通信协议。它提供可靠交付，有流量控制，拥塞控制，提供全双工通信，面向字节流（把应用层传下来的报文看成字节流，把字节流组织成大小不等的数据块），每一条 TCP 连接只能是点对点的（一对一）。



### 特点

![](https://images.yingwai.top/picgo/20210809115951.jpg)

* **面向连接：**一定是「一对一」才能连接，不能像 UDP 协议可以一个主机同时向多个主机发送消息，也就是一对多是无法做到的；
* **可靠的**：无论的网络链路中出现了怎样的链路变化，TCP 都可以保证一个报文一定能够到达接收端；
* **字节流**：消息是「没有边界」的，所以无论我们消息有多大都可以进行传输。并且消息是「有序的」，当「前一个」消息没有收到的时候，即使它先收到了后面的字节，那么也不能扔给应用层去处理，同时对「重复」的报文会自动丢弃。

为了实现TCP上述的特点，TCP协议需要解决的是面向连接（建立连接和关闭连接的方式）、可靠传输（错误确认和重传）、流量控制（发送方和接收方的传输速率协调）、拥塞控制四个方面。

**参考链接：**

* [TCP 缺陷与改进](https://www.zhihu.com/question/47560918)



### 三次握手

TCP 是面向连接的协议，所以使用 TCP 前必须先建立连接，而**建立连接是通过三次握手来进行的。**

![](https://images.yingwai.top/picgo/20210718203242.png)

- 首先服务端处于 `LISTEN`（监听）状态，等待客户端的连接请求；
- 第一次握手：客户端发送 SYN 包（seq = x）到服务器，并进入`SYN_SEND`状态，等待服务器确认；
- 第二次握手：服务器收到 SYN包，必须确认客户的 SYN（ack = x+1），同时自己也发送一个 SYN 包（seq = y），即 SYN + ACK 包，此时服务器进入`SYN_RECV`状态;
- 第三次握手：客户端收到服务器的 SYN + ACK 包，向服务器发送确认包 ACK（ack = y+1），此包发送完毕，客户端和服务器进入`ESTABLISHED`状态，完成三次握手。

#### 为什么需要三次握手？

* 三次握手才可以阻止重复历史连接的初始化（主要原因）
* 三次握手才可以同步双方的初始序列号
* 三次握手才可以避免资源浪费



#### 初始序列号 ISN 是如何随机产生的？

初始 `ISN` 是基于时钟的，每 4 毫秒 + 1，转一圈要 4.55 个小时。

RFC1948 中提出了一个较好的初始化序列号 ISN 随机生成算法。

***ISN = M + F (localhost, localport, remotehost, remoteport)***

- `M` 是一个计时器，这个计时器每隔 4 毫秒加 1。
- `F` 是一个 Hash 算法，根据源 IP、目的 IP、源端口、目的端口生成一个随机数值。要保证 Hash 算法不能被外部轻易推算得出，用 MD5 算法是一个比较好的选择。



## UDP

