# 数据库

以下大部分内容针对MySQL。

## 索引

### 索引数据结构

MySQL中MyISAM和InnoDB引擎都使用了B+树作为索引结构。

### B+树

`B+树`是一种数据结构，是一个N叉排序树，每个节点通常有多个孩子，一棵`B+树`包含根节点、内部节点和叶子节点。根节点可能是一个叶子节点， 也可能是一个包含两个或两个以上孩子节点的节点。

B+树的特点如下：

1. 非叶子节点的子树指针与关键字个数相同；
2. 非叶子节点的子树指针`p[i]`，指向关键字值属于`[k[i],k[i+1]]`的子树。(B树是开区间，也就是说B树不允许关键字重复，B+树允许重复)；
3. 所有叶子节点有一个指针相连，且都位于同一层；
4. 所有关键字都在叶子节点出现（稠密索引），且链表中的关键字恰好是有序的；
5. 非叶子节点相当于是叶子节点的索引（稀疏索引），叶子节点相当于是存储（关键字）数据的数据层；
6. 更适合于文件系统。

#### 使用B+树作为索引结构的原因

* 非叶子节点不存储关键字，只存储索引指针，这样能使尽可能多的索引指针存储在同一个磁盘页中，可以减少磁盘IO次数；
* 可以将一个节点的大小设为等于一个页，这样每个节点只需要一次I/O就可以完全载入；
* 查询效率稳定（叶子节点都在同一层）；
* 叶子节点之间有指针相连，方便进行遍历和范围查询。



### 联合索引

两个或更多个列上的索引被称作联合索引，联合索引又叫复合索引。对于复合索引：Mysql从左到右的使用索引中的字段，一个查询可以只使用索引中的一部份，但只能是最左侧部分。例如索引是`key index (a,b,c)`，可以支持`a | a,b | a,b,c` 3种组合进行查找，但不支持`b,c`进行查找。当最左侧字段是常量引用时，索引就十分有效。

#### 最左匹配

所谓最左原则指的就是如果你的 SQL 语句中用到了联合索引中的最左边的索引，那么这条 SQL 语句就可以利用这个联合索引去进行匹配，值得注意的是，当遇到范围查询(`>, <, between, like`)就会停止匹配。

#### 原理

假设对`(a,b)`字段建立索引，如下图所示：

![](https://images.yingwai.top/picgo/20210719225322.png)

它们首先是按照`a`来进行排序，在`a`相等的情况下，才按`b`来排序。因此，我们可以看到`a`是有序的`1, 1, 2, 2, 3, 3`。而`b`是一种全局无序，局部相对有序状态。



## 存储引擎

查看存储引擎命令：

```mysql
SHOW ENGINES
```

在MySQL中，不需要在整个服务器中使用同一种存储引擎，针对具体的要求，可以对每一个表使用不同的存储引擎。Support列的值表示某种引擎是否能使用：YES表示可以使用、NO表示不能使用、DEFAULT表示该引擎为当前默认的存储引擎。下面来看一下其中几种常用的引擎。

### [各主要存储引擎对比](https://www.cnblogs.com/pengpengdeyuan/p/15001739.html)

|         功能         | InnoDB | MyISAM |           Memory            |
| :------------------: | :----: | :----: | :-------------------------: |
|       索引结构       |  B+树  |  B+树  | 默认Hash，也可以使用B树索引 |
|   备份/时间点恢复    |   是   |   是   |             是              |
|       聚集索引       |   是   |   否   |             否              |
|       压缩数据       |   是   |   是   |             否              |
|       加密数据       |   是   |   是   |             是              |
|       外键支持       |   是   |   否   |             否              |
|     全文搜索索引     |   是   |   是   |             否              |
| 地理空间数据类型支持 |   是   |   是   |             否              |
|       索引缓存       |   是   |   是   |             否              |
|       锁定粒度       |   行   |   表   |             表              |
|         MVCC         |   是   |   是   |             是              |
|       复制支持       |   是   |   是   |            限量             |
|       储存限制       |  64TB  | 256TB  |            内存             |



## 优化

### 如果一条sql语句特别慢，如何分析？

**偶尔很慢：**

1. 数据库在刷新脏页，例如 redo log 写满了需要同步到磁盘
2. 执行的时候，遇到锁，如表锁、行锁（可以用 `show processlist` 命令查看当前状态）

**一直很慢：**

1. 没有用上索引：
   * 该字段没有索引
   * 由于对字段进行运算、函数操作导致无法用索引
2. [数据库选错了索引](https://www.cnblogs.com/kubidemanong/p/10734045.html)（可以用 `explain` 命令查看执行计划，也可以在查询时用 `force index(a)` 来强制使用索引 a）

