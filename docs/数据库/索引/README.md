# 索引

## 索引数据结构

MySQL中MyISAM和InnoDB引擎都使用了B+树作为索引结构，还有别的一些数据库如Mongodb使用的是B树。

### B-树

![](https://images.yingwai.top/picgo/20210725144527.jpg)

B-树，这里的 B 表示 balance( 平衡的意思)，B-树是一种多路自平衡的搜索树（B树是**一颗多路平衡查找树**）。它类似普通的平衡二叉树，不同的一点是B-树允许每个节点有更多的子节点。上图是 B-树的简化图。

B-树特点如下：

1. 所有键值分布在整颗树中（索引值和具体data都在每个节点里）；
2. 任何一个关键字出现且只出现在一个结点中；
3. 搜索有可能在非叶子结点结束（最好情况`O(1)`就能找到数据）；
4. 在关键字全集内做一次查找，性能逼近二分查找；



### B+树

![](https://images.yingwai.top/picgo/20210725101256.jpg)

B+树为B树的变形结构，用于大多数数据库或文件系统的存储而设计。它是一个N叉排序树，每个节点通常有多个孩子，一棵`B+树`包含根节点、内部节点和叶子节点。根节点可能是一个叶子节点， 也可能是一个包含两个或两个以上孩子节点的节点。

B+树的特点如下：

1. 非叶子节点的子树指针与关键字个数相同；
2. 非叶子节点的子树指针`p[i]`，指向关键字值属于`[k[i],k[i+1]]`的子树。(B树是开区间，也就是说B树不允许关键字重复，B+树允许重复)；
3. 所有叶子节点有一个指针相连，且都位于同一层；
4. 所有关键字都在叶子节点出现（稠密索引），且链表中的关键字恰好是有序的；
5. 非叶子节点相当于是叶子节点的索引（稀疏索引），叶子节点相当于是存储（关键字）数据的数据层；
6. 更适合于文件系统。

#### 使用B+树作为索引结构的原因

* 非叶子节点不存储关键字，只存储索引指针，这样能使尽可能多的索引指针存储在同一个磁盘页中，可以减少磁盘IO次数；
* 可以将一个节点的大小设为等于一个页，这样每个节点只需要一次I/O就可以完全载入；
* 查询效率稳定（叶子节点都在同一层）；
* 叶子节点之间有指针相连，方便进行遍历和范围查询。



### 总结

|                             B树                              |                             B+树                             |
| :----------------------------------------------------------: | :----------------------------------------------------------: |
| B树的树内存储数据，因此查询单条数据的时候，B树的查询效率不固定，最好的情况是`O(1)` | B+树的数据只出现在叶子节点上，因此在查询单条数据的时候，查询速度非常稳定 |
| 在做单一数据查询的时候，平均性能更好；但不适合做一些数据遍历操作 | 在做单一数据的查询上，平均性能不如B树；但非常适合做范围查询  |
|              适用于非关系型数据库（单一查询多）              |          适用于关系型数据库（遍历、关联查询操作多）          |



## 联合索引

两个或更多个列上的索引被称作联合索引，联合索引又叫复合索引。对于复合索引：Mysql从左到右的使用索引中的字段，一个查询可以只使用索引中的一部份，但只能是最左侧部分。例如索引是`key index (a,b,c)`，可以支持`a | a,b | a,b,c` 3种组合进行查找，但不支持`b,c`进行查找。当最左侧字段是常量引用时，索引就十分有效。

### 最左匹配

所谓最左原则指的就是如果你的 SQL 语句中用到了联合索引中的最左边的索引，那么这条 SQL 语句就可以利用这个联合索引去进行匹配，值得注意的是，当遇到范围查询(`>, <, between, like`)就会停止匹配。

#### 原理

假设对`(a,b)`字段建立索引，如下图所示：

![](https://images.yingwai.top/picgo/20210719225322.png)

它们首先是按照`a`来进行排序，在`a`相等的情况下，才按`b`来排序。因此，我们可以看到`a`是有序的`1, 1, 2, 2, 3, 3`。而`b`是一种全局无序，局部相对有序状态。



## 索引生效相关问题

参考链接：

* [索引失效原理，终于有人讲明白了](https://cloud.tencent.com/developer/article/1704743)

### 范围查询右边索引会失效吗？

比如以下查询语句：

```sql
SELECT * FROM test_table WHERE a > 1 AND b = 2;
```

会，首先 a 字段在B+树上是有序的，所以可以用二分查找法定位到1，然后将所有大于 1 的数据取出来，a 可以用到索引。

b 有序的前提是 a 是确定的值，那么现在 a 的值是取大于 1 的，可能有 10 个大于 1 的 a，也可能有一百个 a。

大于 1 的 a 那部分的B+树里，b 字段是无序的，所以 b 不能在无序的B+树里用二分查找来查询，b 用不到索引。



### [为什么分页查询时查询越靠后的记录就越慢？](https://cloud.tencent.com/developer/article/1639177)

比如 user 表里有500w的数据，现在有一个普通的分页查询：

```sql
SELECT * FROM user ORDER BY id DESC LIMIT 100, 10;
```

这是查询第十页的数据。这条语句中的偏移量越大，查询的时候就越久，原因要从 LIMIT 分页原理进行分析。

原因是当 LIMIT 分页的偏移量越大的时候扫描的行数就越多，比如要查询的偏移量为100w，那么limit会扫描1000010行，然后丢弃前100w行数据，留下最后10行，返回给我们。

#### 优化方式

* **最大 ID 查询法**：记录上一次查询的最大 ID，下一页就可以根据这个最大 ID 来进行查询，只适用于自增 ID；
* **使用 `BETWEEN ... AND`：**这种方式也只适用于自增 ID 且 ID 没有断裂；
* 
